<?xml version="1.0" encoding="UTF-8"?>
<flow xmlns="http://www.springframework.org/schema/webflow"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://www.springframework.org/schema/webflow
    http://www.springframework.org/schema/webflow/spring-webflow-2.0.xsd">

    <var name="identifier" class="org.openregistry.core.domain.jpa.JpaIdentifierImpl"/>

    <view-state id="netIDActivation" model="identifier" view="openregistry.netid.activation">
        <binder>
            <binding property="value" required="true"/>
            <binding property="activationKey.value" required="true"/>
        </binder>
        <on-render>
            <set name="viewScope.command" value="'identifier'" />
            <evaluate expression="identifier.addActivationKey()" />
        </on-render>
        <transition on="submitNetIDActivation" to="getPassword" bind="true" validate="true">
            <set name="flowScope.identifier" value="identifier" />
            <evaluate expression="identifierAction.verifyActivationKey(identifier,messageContext)"/>
        </transition>
    </view-state>

    <view-state id="getPassword" view="openregistry.netid.activation.password" model="identifier">
        <on-render>
            <set name="viewScope.command" value="'identifier'" />
            <set name="identifier" value="flowScope.identifier" />
        </on-render>
        <transition on="submitNetIDPassword" to="activatedNetID" >
            <set name="requestScope.password" value="requestParameters.password" />
            <evaluate expression="identifierAction.activate(flowScope.identifier, password, messageContext)" />
        </transition>
    </view-state>

    <view-state id="activatedNetID" view="openregistry.netid.activation.password">
        <on-render>
            <set name="flowScope.addSucceeded" value="'addSucceeded'"/>
        </on-render>
        <transition to="netIDActivated" />
    </view-state>

    <end-state id="netIDActivated" />
</flow>